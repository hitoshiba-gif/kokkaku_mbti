<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="color-scheme" content="light dark">
<title>骨格MBTI Web診断 v3（Final + Brand/Style）</title>
<style>
:root{--bg:#0f1115;--card:#161922;--ink:#e7e9ee;--muted:#aab0c0;--accent:#7c9cff;--soft:#24293a;--ok:#38d39f;--warn:#ffce5c}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.6;color:var(--ink);background:linear-gradient(180deg,#0e1017,#0f131d 35%,#0b0e15)}
.wrap{max-width:980px;margin:0 auto;padding:32px 20px}
header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
header .badge{padding:4px 10px;border-radius:999px;background:var(--soft);font-size:12px;color:var(--muted)}
h1{font-size:24px;margin:0}
.card{background:var(--card);border:1px solid #212638;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
.controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
button{appearance:none;border:none;border-radius:10px;padding:12px 16px;background:var(--accent);color:#0b0e15;font-weight:700;cursor:pointer}
button.secondary{background:var(--soft);color:var(--ink)}
.muted{color:var(--muted)}
.grid{display:grid;gap:14px}
.q{padding:14px;border:1px solid #262b3a;border-radius:12px;background:#121625}
.q h4{margin:0 0 8px 0;font-size:15px}
.scale{display:flex;gap:8px;align-items:center}
.scale label{font-size:12px;color:var(--muted)}
.scale input{accent-color:var(--accent);width:100%}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px}
.progress{height:8px;background:#0d1220;border:1px solid #262b3a;border-radius:999px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),#8ff0d1);width:0}
.pill{padding:4px 8px;background:#111523;border:1px solid #262b3a;border-radius:999px;color:var(--muted);font-size:12px}
.result{display:grid;gap:10px}
.result h2{margin:0}
.tags{display:flex;gap:8px;flex-wrap:wrap}
.tag{padding:6px 10px;border:1px solid #2a2f40;border-radius:999px;background:#121625;color:#cfd6eb;font-size:12px}
.cols{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:860px){.cols{grid-template-columns:1.2fr .8fr}}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #23283a;padding:8px 6px;text-align:left}
.ok{color:var(--ok)}.warn{color:var(--warn)}
.hero{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:12px;border:1px solid #2a2f40;background:#0f1220;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.concept{font-size:14px;color:var(--muted);line-height:1.8}
.em{font-size:20px}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.chip{padding:6px 10px;border:1px solid #2a2f40;border-radius:999px;background:#111523;color:#cfd6eb;font-size:12px}
.guide h3{margin:14px 0 8px}
.guide h4{margin:10px 0 6px}
.guide ul{margin:0 0 8px 18px}
.small{font-size:12px;color:var(--muted)}

  /* 既存<style>内のどこでもOK */
  .traits{display:grid;gap:14px;margin-top:12px}
  .trait{background:#121625;border:1px solid #262b3a;border-radius:12px;padding:12px}
  .trait .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .trait .title{font-weight:700}
  .trait .percent{font-weight:700}
  .meter{position:relative;height:10px;background:#0d1220;border:1px solid #262b3a;border-radius:999px;overflow:hidden}
  .meter .fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent),#8ff0d1)}
  .meter .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;
    background:#e7e9ee;border:2px solid #111523;box-shadow:0 2px 6px rgba(0,0,0,.4)}
  .trait .ends{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}
/* ===== Mobile first tweaks ===== */
:root{
  --space:16px;
}

/* 全体タイポ・余白を少し大きめに */
body{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
.wrap{ padding: 20px var(--space); }
h1{ font-size: 20px; }

/* カード/質問の詰めを少しゆるく */
.card{ padding:16px; border-radius:14px; }
.q{ padding:12px; border-radius:12px; }
.q h4{ font-size:14px; line-height:1.5; }

/* コントロールを縦積み&フル幅 */
.controls{ gap:10px; }
@media (max-width: 760px){
  .controls{ flex-direction:column; }
  button, .controls button{ width:100%; padding:14px 16px; font-size:16px; }
}

/* 2カラム→1カラム（結果やガイド） */
.cols{ grid-template-columns:1fr; }
@media (min-width: 860px){
  .cols{ grid-template-columns:1.2fr .8fr; }
}

/* 進捗フッターをスマホで“下部固定”に */
@media (max-width: 760px){
  .footer{ 
    position: sticky; bottom: 0; z-index: 20;
    background: linear-gradient(180deg, rgba(15,17,21,0), var(--card));
    padding-top: 10px; margin-top: 18px;
  }
}

/* バーUI：指で触れやすいサイズ */
.meter{ height:14px; border-radius:999px; }
.meter .thumb{ width:22px; height:22px; }

/* スライダー：親指大きめ（iOS/Android） */
input[type=range]{ height: 30px; }
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width:26px; height:26px; border-radius:50%;
  background:#e7e9ee; border:2px solid #111523; box-shadow:0 2px 6px rgba(0,0,0,.4);
}
input[type=range]::-moz-range-thumb{
  width:26px; height:26px; border-radius:50%;
  background:#e7e9ee; border:2px solid #111523; box-shadow:0 2px 6px rgba(0,0,0,.4);
}

/* 画像比率をスマホ寄りに */
.hero{ aspect-ratio: 4 / 3; }

/* タグ/チップの折返し間隔を改善 */
.tags,.chips{ gap:6px; }
.chip,.tag{ font-size:11px; padding:6px 8px; }

/* 安全域（iOSノッチ対応） */
@supports(padding:max(0px)){
  body{ padding-bottom: max(0px, env(safe-area-inset-bottom)); }
}
/* --- iPhone Safariで真っ暗になるバグ対策 --- */
html, body {
  background-color: #0f1115 !important;
  color: #e7e9ee !important;
  height: 100%;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-text-size-adjust: 100%;
}

#app, .wrap {
  background-color: #0f1115;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

.card {
  background-color: #161922;
  color: #e7e9ee;
}

/* Safariが文字を透明化することがあるので強制指定 */
h1, h2, h3, p, span, label, button {
  color: #e7e9ee !important;
}

/* 背景グラデーションが透過して見えないときのため */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #0e1017, #0f131d 35%, #0b0e15);
  z-index: 0;
}
/* ===== Dashboard styling ===== */
.dash{ margin-top: 40px; }
.dash-card{
  background: var(--card);
  border: 1px solid #23283a;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  padding: 18px;
}
.dash-head{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
.dash-head h2{ margin: 0; font-size: 18px; }
.dash-head .muted{ margin: 0; }

.dash-frame{
  margin-top: 12px;
  border-radius: 12px;
  overflow: hidden;               /* 角丸を効かせる */
  background: #0f1115;            /* iFrame読込前の色 */
  border: 1px solid #2a2f40;
}

/* iFrameをレスポンシブに（16:9） */
.dash-embed{
  width: 100%;
  aspect-ratio: 16 / 9;           /* モダンブラウザOK */
  display: block;
  border: 0;
}

/* 横幅を広げすぎない */
@media (min-width: 860px){
  .dash-card{ padding: 22px; }
  .dash{ max-width: 1100px; margin-left:auto; margin-right:auto; }
}





</style>
</head>
<body>
<div class="wrap">
  <header>
    <span class="badge">Final Edition</span>
    <h1>骨格MBTI Web診断 v3</h1>
  </header>
  <div id="app" class="card"></div>
  <section id="dashboard" class="dash">
  <div class="dash-card">
    <div class="dash-head">
      <h2>みんなの診断傾向</h2>
      <p class="muted">最新集計をリアルタイム表示</p>
    </div>

    <div class="dash-frame">
      <iframe
        class="dash-embed"
        src="https://lookerstudio.google.com/embed/reporting/6a1b780b-386d-466c-9624-2e5f9f93f90c/page/Dk1cF"
        allowfullscreen
        frameborder="0">
      </iframe>
    </div>
  </div>
</section>

</div>

<script>
  // ============ Google Sheets連携設定 ============
const GAS_URL = "https://script.google.com/macros/s/AKfycbxVWOXNr9rqQsIE5kJl5Ujk1gUJXTIhXGivuojjZbOtGwyvq4-Pp6F4u6K6o7DV9Nuj/exec"
function sendToSheets(payload){
  console.log('[GAS] sending...', payload);
  return fetch(GAS_URL, {
    method: "POST",
    // ★ プリフライトを発生させない許可タイプ
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload),
  })
  .then(r => r.text().then(t => {
    console.log('[GAS] response:', r.status, t);
    return { status: r.status, body: t };
  }))
  .catch(e => console.error('[GAS] error:', e));
}

// ユーザーの同意状態を保存/取得（ローカルに保持）
const CONSENT_KEY = 'km_consent'; // 'yes' | 'no'
function getConsent(){ return localStorage.getItem(CONSENT_KEY) ?? 'yes'; } // 既定=同意
function setConsent(v){ localStorage.setItem(CONSENT_KEY, v ? 'yes' : 'no'); }

function makeInitialState(){
  const make = n => Array(n).fill(3); // スライダー初期値=3
  return {
    step: 0,
    _sentOnce: false,                 // 自動送信フラグもリセット
    answers: {
      frame:   make(12),
      surface: make(12),
      balance: make(12),
      line:    make(12)
    }
  };
}

/* ───────── 4軸定義 ───────── */
const AXES = [
  {key:'frame', codePos:'B', codeNeg:'M', label:'構造軸（Frame）', posLabel:'骨格主導（B）', negLabel:'肉付き主導（M）', threshold:3.5},
  {key:'surface', codePos:'W', codeNeg:'N', label:'面積軸（Density）', posLabel:'身体フレーム広（L）', negLabel:'身体フレーム狭（N）', threshold:3.5},
  {key:'balance', codePos:'U', codeNeg:'L', label:'重心軸（Balance）', posLabel:'上重心（U）', negLabel:'下重心（L）', threshold:3.5},
  {key:'line', codePos:'C', codeNeg:'S', label:'ライン軸（Line）', posLabel:'直線（C）', negLabel:'曲線（S）', threshold:3.5}
];

/* ───────── 質問（各12問・5段階） ───────── */
const QUESTIONS = {
  frame:[
    {t:'鎖骨や肋骨のラインがはっきりしている',pos:true},
    {t:'手首や足首の骨が目立ち、その他の部位も関節が目立つ',pos:true},
    {t:'肩や太ももに骨ぼねしさを感じる',pos:false},
    {t:'体全体が直線的で、凹凸が少ない',pos:true},
    {t:'動いたとき、筋肉の動きがわかりずらい',pos:false},
    {t:'身体付きが「シャープ」と言われる',pos:true},
    {t:'顔に脂肪がつきにくい',pos:false},
    {t:'写真で見ると骨の位置がわかる',pos:true},
    {t:'厚手の服でも骨の形が出やすい',pos:true},
    {t:'運動をしても筋肉がつきずらい',pos:false},
    {t:'座ると骨盤や関節がごつごつ感じられる',pos:true},
    {t:'自分の体型は「骨の形」によって決まっている',pos:true}
  ],
  surface:[
    {t:'周囲から実際の身長よりも大きく見えると言われる',pos:true},
    {t:'肩幅の大きさが顔の横幅三つ分の大きさよりも大きい',pos:true},
    {t:'厚手より薄手・軽い素材がしっくりくる',pos:true},
    {t:'静止すると存在感が強く、安定して見える',pos:false},
    {t:'腕の長さが膝とお尻の中間くらいまである',pos:true},
    {t:'手が大きいとよく言われる',pos:true},
    {t:'体のメリハリが少ない',pos:true},
    {t:'写真で他人と並ぶと身体が大きく見える',pos:true},
    {t:'首元がゆったりした服がよく似合う',pos:false},
    {t:'厚みがなく横に広がるような体型をしている',pos:false},
    {t:'ビッグシルエットの服が似合う',pos:false},
    {t:'食べても筋肉や脂肪が付きづらい',pos:false}
  ],
  balance:[
    {t:'鏡を見ると上半身が目立つように感じる',pos:true},
    {t:'腰・ヒップが目立つ',pos:false},
    {t:'脚が長く見える',pos:true},
    {t:'ウエストラインが高く見える',pos:false},
    {t:'座ると上半身が詰まって見える',pos:true},
    {t:'立つと胸や肩の位置が高く見える',pos:true},
    {t:'ボディラインの出る服が似合う',pos:false},
    {t:'トップスにボリュームを出すと似合う',pos:true},
    {t:'ワイドパンツよりもスキニーパンツが似合う',pos:false},
    {t:'上半身にアクセサリーや柄を持ってくるとしっくりくる',pos:true},
    {t:'首の長さが短め',pos:false},
    {t:'着丈の短いトップスが似合う',pos:true}
  ],
  line:[
    {t:'手足や体の輪郭がまっすぐに見える',pos:true},
    {t:'肩や腰に丸みがない',pos:false},
    {t:'「シャープ」と言われる',pos:true},
    {t:'首元が空いている服は貧相に見えると言われる',pos:false},
    {t:'直線的な服が似合う',pos:true},
    {t:'スーツやシャツがよく似合う',pos:false},
    {t:'動作がキビキビしている印象がある',pos:true},
    {t:'オーバーサイズの服を切ると着痩せする',pos:false},
    {t:'横顔や横姿が直線的に見える',pos:true},
    {t:'顔の骨が目立つ',pos:false},
    {t:'コンパクトな髪型がよく似合う',pos:true},
    {t:'全体の印象が「すっきり」している',pos:true}
  ]
};

/* ───────── Final TYPE 定義（16タイプ：動物・ブランド・ノート） ───────── */
/* 画像は任意（images/CODE.jpg）。brandHints/styleNotes は結果画面に表示 */
const TYPE_META = {
  /* WAVE（柔・軽・下重心） */
  BNLS:{name:'Romantic Wave', base:'WAVE', emoji:'🐨', animal:'コアラ',
    image:'images/BNLS.jpg',
    concept:'甘くやわらか、包容感のあるロマン。',
    brandHints:['SNIDEL','CELFORD','TOCCA','Lily Brown','FRAY I.D','IÉNA','Noela'],
    styleNotes:['ソフトな曲線シルエット','ドレープ/ギャザーの分量はやや控えめ','落ち感あるミディ丈','中～淡色のワントーン','アクセは丸モチーフ'],
    celebrities: {
    jp: ['北川景子','有村架純','石田ゆり子'],
    kr: ['TWICE ナヨン','LE SSERAFIM サクラ'],
    global: ['Lily Collins','Emma Watson']
  }
},
  MNLC:{name:'Urban Elegance (Wave)', base:'WAVE', emoji:'🐺', animal:'オオカミ',
    image:'images/MNLC.jpg',
    concept:'静かで芯のある優しさ、穏やかに知的な洗練。',
    brandHints:['IÉNA','Mila Owen','Plage','N.O.R.C','URBAN RESEARCH','TOMORROWLAND'],
    styleNotes:['Iラインをベースに柔らか素材','ロング×ロングより上に一点ボリューム','ニュアンスカラーで都会的に','シャープ過ぎないテーラード'],
    celebrities: {
    jp: ['黒木華','宮崎あおい','吉高由里子'],
    kr: ['ITZY リア'],
    global: ['Keira Knightley','Natalie Portman']
  }
},
  MWLC:{name:'Light Wave', base:'WAVE', emoji:'🦋', animal:'バタフライ',
    image:'images/MWLC.jpg',
    concept:'風に舞う透明感、まっすぐで軽やかな均衡。',
    brandHints:['N.O.R.C','IÉNA','UNIQLO','BEAUTY&YOUTH','TOMORROWLAND','LE PHIL'],
    styleNotes:['直線×薄手で軽やかに','ハイウエストで脚長見せ','余白を作るショート丈トップス','繊細アクセで軽さを強調'],
    celebrities: {
    jp: ['浜辺美波','堀北真希'],
    kr: ['NewJeans ヘイン'],
    global: ['Selena Gomez','Lily Collins']
  }
},
  MWLS:{name:'Natural Girly', base:'WAVE', emoji:'🐹', animal:'ハムスター',
    image:'images/MWLS.jpg',
    concept:'丸みと温かみ、ふんわりとした可憐さ。',
    brandHints:['SNIDEL','earth music&ecology','Kastane','LOWRYS FARM','tocco closet'],
    styleNotes:['Aライン/フレアで下重心を活かす','柔らかニットとスカートの組合せ','丸襟/スカーフタイで可憐に','小ぶりバッグで重さを出さない'],
    celebrities: {
    jp: ['上戸彩','桜井日奈子'],
    kr: ['aespa ウィンター','Red Velvet アイリーン'],
    global: ['Ariana Grande','Selena Gomez']
  }
},
  MNLS:{name:'Classic Feminine', base:'WAVE', emoji:'🕊', animal:'白鳩',
    image:'images/MNLS.jpg',
    concept:'柔らかく上品、穏やかに香るエレガンス。',
    brandHints:['TOCCA','EPOCA','FOXEY','ANAYI','Apuweiser-riche'],
    styleNotes:['曲線的なネック/ハートネック','ミディ～ロングのフレア','サテン/ジョーゼットの艶','上品な真珠アクセ'],
    celebrities: {
    jp: ['新垣結衣','白石麻衣'],
    kr: ['IVE ウォニョン','Red Velvet アイリーン'],
    global: ['Ariana Grande','Lily Collins']
  }
},
  BNLC:{name:'Earth Wave', base:'WAVE', emoji:'🐻', animal:'クマ',
    image:'images/BNLC.jpg',
    concept:'あたたかく包み込む安定感、癒しの重心。',
    brandHints:['URBAN RESEARCH ROSSO','Plage','DOORS','JOURNAL STANDARD relume','IÉNA'],
    styleNotes:['ロングカーデやカバーオールで包み込む','落ち感素材で重さを分散','中明度アースカラー','靴は厚底すぎない安定型'],
    celebrities: {
    jp: ['宮崎あおい','黒木華'],
    kr: ['ITZY リア'],
    global: ['Keira Knightley','Kristen Stewart']
  }
},

  /* NATURAL（BL系のみ） */
  BWUC:{name:'Urban Natural', base:'NATURAL', emoji:'🦄', animal:'ユニコーン',
    image:'images/BWUC.jpg',
    concept:'直線×余白、幻想と構造の調和。',
    brandHints:['JOURNAL STANDARD','UNITED ARROWS','BEAUTY&YOUTH','AURALEE','YLEVE','TODAYFUL'],
    styleNotes:['直線×ゆとりのミニマル','軽いセットアップ','余白を残すアウトライン','硬すぎない上質素材'],
    celebrities: {
    jp: ['中村アン','水原希子'],
    kr: ['BLACKPINK リサ','LE SSERAFIM ユンジン'],
    global: ['Cara Delevingne','Gigi Hadid']
  }
},
  BWUS:{name:'Fairy Natural', base:'NATURAL', emoji:'🦅', animal:'タカ',
    image:'images/BWUS.jpg',
    concept:'軽やかで透徹した知性、俯瞰の美学。',
    brandHints:['ENFÖLD','Deuxieme Classe','TOMORROWLAND','athoos','COS'],
    styleNotes:['上半身をコンパクトに','直線多めのレイヤード','淡色×無機質アクセ','クリーンなスニーカー/ローファー'],
    celebrities: {
    jp: ['綾瀬はるか','戸田恵梨香'],
    kr: ['NewJeans ヘリン'],
    global: ['Zendaya','Keira Knightley']
  }
},
  BWLC:{name:'Classic Natural', base:'NATURAL', emoji:'🦊', animal:'キツネ',
    image:'images/BWLC.jpg',
    concept:'端正で機敏、自然体の品格。',
    brandHints:['IÉNA','Plage','TOMORROWLAND','BEAMS','URBAN RESEARCH'],
    styleNotes:['端正なシャツ/テーラード','リネン/コットンで清涼感','センタープレスで直線強調','色はベージュ～ネイビー軸'],
    celebrities: {
    jp: ['吉高由里子','杏'],
    kr: ['LE SSERAFIM ユンジン'],
    global: ['Cara Delevingne','Keira Knightley']
  }
},

  BWLS:{name:'Pure Natural', base:'NATURAL', emoji:'🦌', animal:'シカ',
    image:'images/BWLS.jpg',
    concept:'柔らかく静かな調和、森の中の安らぎ。',
    brandHints:['nest Robe','Vermeerist BEAMS','Plage','Journal Standard L’essage'],
    styleNotes:['下に落ちるAライン','テクスチャーを重ねる','ソフトカラーでグラデ','アクセは木/革など自然素材'],
    celebrities: {
    jp: ['宮崎あおい','黒木華'],
    kr: ['aespa ウィンター','NewJeans ヘリン'],
    global: ['Keira Knightley','Kristen Stewart']
  }
},

  /* STRAIGHT（厚・立体・上重心） */
  BNUS:{name:'Elegant Straight', base:'STRAIGHT', emoji:'🐆', animal:'パンサー',
    image:'images/BNUS.jpg',
    concept:'凛として構築的、都会的モード。',
    brandHints:['Theory','Max Mara','FOXEY','PLST','LE PHIL','TIBI'],
    styleNotes:['上重心を活かすショート丈×ハイウエスト','直線テーラード','ハリ素材のIライン','高コントラスト配色'],
    celebrities: {
    jp: ['長澤まさみ','田中みな実'],
    kr: ['IVE ユジン'],
    global: ['Jennifer Lopez','Scarlett Johansson']
  }
},

  MWUC:{name:'Sporty Cool', base:'STRAIGHT', emoji:'🦈', animal:'サメ',
    image:'images/MWUC.jpg',
    concept:'鋭くスマート、研ぎ澄まされたスピード感。',
    brandHints:['NIKE Sportswear','adidas Originals','P.E NATION','COS','UNIQLO U'],
    styleNotes:['クリーンなアスレジャー','直線的トラックパンツ×短丈トップス','機能素材×モノトーン','スニーカーは厚底すぎない'],
    celebrities: {
    jp: ['広瀬すず','菜々緒'],
    kr: ['Red Velvet スルギ'],
    global: ['Taylor Swift','Gal Gadot']
  }
},

  MNUC:{name:'Glamorous Cool', base:'STRAIGHT', emoji:'🐅', animal:'トラ',
    image:'images/MNUC.jpg',
    concept:'立体感と色気、強い存在感。',
    brandHints:['Max Mara','ZARA Premium','THE ROW','LE CIEL BLEU','N°21'],
    styleNotes:['厚み×直線で構築','ウエスト位置を高く','ダークトーンに一点光沢','ヒールで重心を上へ'],
    celebrities: {
    jp: ['深田恭子','佐々木希'],
    kr: ['BLACKPINK ジス','TWICE モモ'],
    global: ['Angelina Jolie','Jennifer Lopez']
  }
},

  MNUS:{name:'Romantic Mode', base:'STRAIGHT', emoji:'🦚', animal:'クジャク',
    image:'images/MNUS.jpg',
    concept:'力と優雅の共存、華やかな余韻。',
    brandHints:['Self-Portrait','N°21','SNIDEL（ドレスライン）','FOXEY','Apuweiser-riche'],
    styleNotes:['曲線を入れたモード','厚手サテン/タフタ','ウエストマーク強','ジュエリーは存在感あり'],
    celebrities: {
    jp: ['石原さとみ','橋本環奈'],
    kr: ['aespa カリナ'],
    global: ['Anne Hathaway','Natalie Portman']
  }
},

  MWUS:{name:'Soft Active (Straight)', base:'STRAIGHT', emoji:'🐬', animal:'イルカ',
    image:'images/MWUS.jpg',
    concept:'すっきりとした流線、しなやかな躍動感。',
    brandHints:['PLEATS PLEASE','ISSEY MIYAKE','UNIQLO U','Theory','Lululemon（クリーン系）'],
    styleNotes:['流線型の直線×軽素材','ハイウエストで脚長','スッキリ襟/クルー/ボート','配色は寒色中心にクリアに'],
    celebrities: {
    jp: ['木村文乃','広瀬すず'],
    kr: ['Red Velvet スルギ','IVE ユジン'],
    global: ['Taylor Swift','Gal Gadot']
  }
},

  BNUC:{name:'Structural Mode', base:'STRAIGHT', emoji:'🦉', animal:'フクロウ',
    image:'images/BNUC.jpg',
    concept:'精密で構築的、夜に光る知性。',
    brandHints:['COS','Theory','AURALEE','HYKE','S’YTE','UNIQLO +J'],
    styleNotes:['モノトーン×建築的ライン','ショート丈ジャケットで上重心','硬質素材で直線を強調','金属系アクセで知性を補強'],
    celebrities: {
    jp: ['松下奈緒','木村文乃'],
    kr: ['TWICE モモ'],
    global: ['Charlize Theron','Cate Blanchett']
  }
}
};

/* ───────── 汎用説明/提案ロジック（タイプ固有が無ければ自動補完） ───────── */
function describeBodyByCode(code){
  const [a,b,c,d]=code.split('');
  const p1=(a==='B')?'骨格や関節の存在感がベース':'肉感・筋肉の厚みがベース';
  const p2=(b==='W')?'全体は軽やかで繊細':'全体は重厚で安定感あり';
  const p3=(c==='U')?'上重心で上半身に視線が集まりやすい':'下重心で下半身に安定が出やすい';
  const p4=(d==='C')?'輪郭は直線寄りでシャープ':'輪郭は曲線寄りでソフト';
  return `【骨格印象まとめ】${p1}。${p2}。${p3}。${p4}。`;
}
function autoBrands(code, base){
  const [a,b,c,d]=code.split('');
  const core={WAVE:['SNIDEL','Lily Brown','Mila Owen','IÉNA','N.O.R.C','URBAN RESEARCH ROSSO'],
              NATURAL:['JOURNAL STANDARD','IÉNA','UNITED ARROWS','BEAUTY&YOUTH','BEAMS','TOMORROWLAND'],
              STRAIGHT:['Theory','Max Mara','PLST','UNIQLO U','COS','ZARA Premium']};
  const addLine=(d==='C')?['COS','Theory','AURALEE']:['SNIDEL','TOCCA','CELFORD'];
  const addDen=(b==='W')?['Deuxieme Classe','ENFÖLD']:['Max Mara','STUNNING LURE'];
  const addBal=(c==='U')?['Drawer','FOXEY']:['URBAN RESEARCH','Spick & Span'];
  return [...new Set([...(core[base]||[]),...addLine,...addDen,...addBal])].slice(0,7);
}
function autoStyle(code){
  const [a,b,c,d]=code.split('');
  const fabric=(b==='N')?['薄手ウール','シフォン/ジョーゼット','スムースニット']:['ミッド〜厚手ウール','ハリのあるツイル','サテン/ジャカード'];
  const neck=(d==='C')?['クルー/ボート','スタンドカラー','浅Vシャツ']:['ラウンド/スカーフタイ','ハートネック','Vネック＋ドレープ'];
  const silhouette=(c==='U')?['短めトップス×ハイウエスト','Iラインワンピ','コンパクトJK']:['ロングトップス×落ち感ボトム','Aライン/フレア','ドロップショルダー'];
  const lines=(d==='C')?['センタープレス','ストレートスカート','テーラード']:['バイアス/ドレープ','マーメイド/フレア','ギャザー控えめ'];
  return {fabric,neck,silhouette,lines};
}

/* ───────── UIレンダリング ───────── */
const $=(s,el=document)=>el.querySelector(s);
const app=document.getElementById('app');
let state = makeInitialState();


function render(){
  app.innerHTML='';
  if(state.step===0) return renderIntro();
  if(state.step>=1 && state.step<=4) return renderAxis(AXES[state.step-1]);
  if(state.step===5) return renderResult();
}

function renderIntro(){
  const el=document.createElement('div');
  el.innerHTML=`
    <div class="result">
      <h2>4印象軸で判定する、16タイプ（Final + Brand/Style）</h2>
      <p class="muted">Frame（骨格/肉感）・Surface（広/狭）・Balance（上/下）・Line（直/曲）をスコア化し、4文字コード（例：BHUC）を生成。<br>タイプごとに動物絵文字・コンセプト・似合うブランド・スタイル指針を表示します。</p>
      <div class="controls">
        <button id="start">はじめる</button>
        <button class="secondary" id="how">設計の考え方</button>
      </div>
    </div>`;
  app.appendChild(el);
  $('#start',el).onclick=()=>{state.step=1;render();};
  $('#how',el).onclick=()=>alert('Final Edition: Natural=BW系のみ／MWUS⇄MNLC入替／各タイプに動物モチーフ、ブランド、スタイルノートを付与。画像は images/CODE.jpg で任意表示。');
}

function renderAxis(axis){
  const {key,label,posLabel,negLabel}=axis; const qs=QUESTIONS[key];
  const progress=(state.step/5)*100;
  const el=document.createElement('div');
  el.innerHTML=`
    <div class="footer" style="margin-bottom:10px">
      <div class="pill">${state.step}/4：${label}</div>
      <div class="progress" style="width:58%"><div class="bar" style="width:${progress}%"></div></div>
    </div>
    <div class="grid">
      ${qs.map((q,i)=>`
        <div class="q">
          <h4>${i+1}. ${q.t}</h4>
          <div class="scale">
            <label>まったく当てはまらない（1）</label>
            <input type="range" min="1" max="5" step="1" value="${state.answers[key][i]}" data-i="${i}"/>
            <label>とても当てはまる（5）</label>
          </div>
          <div class="muted">評価：<span id="v-${key}-${i}">${state.answers[key][i]}</span> / 5</div>
        </div>
      `).join('')}
    </div>
    <div class="footer">
      <div class="pill">${negLabel} ← スケール → ${posLabel}</div>
      <div class="controls">
        <button class="secondary" id="back">戻る</button>
        <button id="next">次へ</button>
      </div>
    </div>`;
  app.appendChild(el);
  el.querySelectorAll('input[type=range]').forEach(r=>{
    r.oninput=e=>{const i=+e.target.dataset.i; const v=+e.target.value; state.answers[key][i]=v; $("#v-"+key+"-"+i,el).textContent=v;}
  });
  
  $('#next',el).onclick=()=>{ state.step=Math.min(5,state.step+1); render(); window.scrollTo({top:0,behavior:'smooth'}); };
$('#back',el).onclick=()=>{ state.step=Math.max(0,state.step-1); render(); window.scrollTo({top:0,behavior:'smooth'}); };

}

function computeAxis(axisKey){
  const arr = state.answers[axisKey].map(Number);
  const qs  = QUESTIONS[axisKey];
  const n   = arr.length;

  // pos=trueならそのまま、falseなら6-vで反転
  const mapped = arr.map((v,i)=> qs[i].pos ? v : (6 - v));

  // 合計と平均
  const total = mapped.reduce((a,b)=>a+b,0);
  const mean5 = total / n;
  const neutral = 3 * n;

  const ax  = AXES.find(a=>a.key===axisKey);
  const pos = total > neutral; // 判定基準
  return { mean: mean5, total, pos, code: pos ? ax.codePos : ax.codeNeg };
}

// 4軸のコード構築
function buildCode(){
  const f=computeAxis('frame'),
        s=computeAxis('surface'),
        b=computeAxis('balance'),
        l=computeAxis('line');
  return {code:`${f.code}${s.code}${b.code}${l.code}`,scores:{frame:f,surface:s,balance:b,line:l}};
}

function renderResult(){
  const {code,scores}=buildCode();
  const meta=TYPE_META[code]||{name:'未定義タイプ',base:'-',emoji:'',animal:'',image:'',concept:'',brandHints:[],styleNotes:[]};
    // --- Google Sheetsに自動送信（最初の1回だけ） ---
  if (!state._sentOnce) {
    state._sentOnce = true;

    const sid = localStorage.getItem('km_session')
      || (localStorage.setItem('km_session', (crypto?.randomUUID?.() ?? String(Math.random()))),
          localStorage.getItem('km_session'));

    sendToSheets({
      code,
      scores,
      userAgent: navigator.userAgent,
      sessionId: sid,
      t: Date.now()
    });
  }

  const el=document.createElement('div');

  const bodyDesc=describeBodyByCode(code);
  const brands=meta.brandHints?.length?meta.brandHints:autoBrands(code,meta.base);
  const auto=autoStyle(code); 
  const notes=(meta.styleNotes?.length?meta.styleNotes:[]);

  // ％算出
  const pf = axisPercent('frame');
  const ps = axisPercent('surface');
  const pb = axisPercent('balance');
  const pl = axisPercent('line');

  // 芸能人ブロック
  let celebHTML = '';
  if (meta.celebrities) {
    const { jp = [], kr = [], global = [] } = meta.celebrities;
    const group = [
      { label: '🇯🇵 日本', list: jp },
      { label: '🇰🇷 韓国', list: kr },
      { label: '🌍 海外', list: global },
    ];
    celebHTML = `
      <div class="card guide" style="margin-top:12px">
        <h3>代表的な芸能人</h3>
        ${group.map(g=> g.list.length
          ? `<h4>${g.label}</h4><div class="chips">${g.list.map(x=>`<span class="chip">${x}</span>`).join('')}</div>`
          : ''
        ).join('')}
        <p class="small">※ 各タイプにおける芸能人分類は公的なものではなく、スタイリング傾向に基づく参考例です。</p>
      </div>
    `;
  }

  // メーターブロック
  const barsHTML = `
    <div class="traits">
      ${[
        {key:'Frame', ax:AXES[0], data:pf},
        {key:'Surface', ax:AXES[1], data:ps},
        {key:'Balance', ax:AXES[2], data:pb},
        {key:'Line', ax:AXES[3], data:pl},
      ].map(({key,ax,data})=>`
        <div class="trait">
          <div class="row">
            <div class="title">${key}：<span class="${data.posSide?'ok':'warn'}">${data.pct}% ${data.sideLabel.replace(/（.*?）/g,'')}</span></div>
            <div class="percent">${data.pct}%</div>
          </div>
          <div class="meter">
            <div class="fill" style="width:${data.pct}%;"></div>
            <div class="thumb" style="left:${data.pct}%;"></div>
          </div>
          <div class="ends">
            <span>${ax.negLabel}</span><span>${ax.posLabel}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  // 結果テンプレ
  el.innerHTML=`
    <div class="cols">
      <div class="card result">
        <h2>診断結果：<span class="ok">${code}</span> — <span class="em">${meta.emoji||''}</span> ${meta.name}</h2>
        <div class="tags">
          <span class="tag">基盤体型：${baseLabel(meta.base)}</span>
          ${meta.animal?`<span class="tag">motif Animal: ${meta.animal}</span>`:''}
        </div>
        <img class="hero" src="${meta.image||''}" alt="${code} image" onerror="this.style.display='none'"/>
        <p class="concept">${meta.concept||''}</p>

        <p class="muted">4軸の平均スコア</p>
        ${barsHTML}
        ${celebHTML}
        <!-- ★ 同意チェック（送信ON/OFFのトグル） -->
<label class="consent" style="display:flex;gap:10px;align-items:center;margin:10px 0 4px;">
  <input type="checkbox" id="consentBox">
  <span class="small">匿名で診断結果を集計保存することに同意します</span>
</label>


        <div class="card guide" style="margin-top:12px">
          <h3>どんな骨格？</h3>
          <p>${bodyDesc}</p>

          <h3>似合いやすいブランド</h3>
          <div class="chips">${brands.map(b=>`<span class="chip">${b}</span>`).join('')}</div>

          <h3>スタイリング指針</h3>
          <div class="cols" style="grid-template-columns:1fr 1fr">
            <div>
              <h4>素材・質感</h4>
              <ul>${auto.fabric.map(x=>`<li>${x}</li>`).join('')}</ul>
              <h4>ネックライン</h4>
              <ul>${auto.neck.map(x=>`<li>${x}</li>`).join('')}</ul>
            </div>
            <div>
              <h4>シルエット</h4>
              <ul>${auto.silhouette.map(x=>`<li>${x}</li>`).join('')}</ul>
              <h4>ライン設計</h4>
              <ul>${auto.lines.map(x=>`<li>${x}</li>`).join('')}</ul>
            </div>
          </div>
          ${notes.length?`<h4>タイプ固有メモ</h4><ul>${notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}
          <p class="small">※ 提案は各軸（骨格/密度/重心/ライン）のスコアとタイプ固有情報から生成。体型や好みに合わせて微調整してください。</p>
        </div>

        <div class="controls">
          <button id="retry" class="secondary">もう一度</button>
          <button id="export">結果をJSONで保存</button>
        </div>
      </div>

      <div class="card">
        <h3>タイプ群の解説</h3>
        <ul>
          <li><b>WAVE</b>：柔・軽・下重心・曲線（🩰 Airy / Gentle / Dreamlike）</li>
          <li><b>NATURAL</b>：骨感・直線・中庸（🌿 Calm / Organic / Minimal）※BL系のみ</li>
          <li><b>STRAIGHT</b>：厚・立体・上重心・直線（🖤 Modern / Powerful / Elegant）</li>
        </ul>
      </div>
    </div>
  `;

// === 自動送信（同意ON かつ 未送信のとき一度だけ） ===
if (!state._sentOnce) {
  const agreed = getConsent() === 'yes';
  if (agreed) {
    state._sentOnce = true;

    const sid = localStorage.getItem('km_session')
      || (localStorage.setItem('km_session', (crypto?.randomUUID?.() ?? String(Math.random()))),
          localStorage.getItem('km_session'));

    const payload = { code, scores, userAgent:navigator.userAgent, sessionId:sid, t:Date.now() };
    sendToSheets(payload);
  }
}

  // ここで一度だけ append

  app.appendChild(el);

  // === 同意チェックの初期状態とイベント ===
const cb = document.getElementById('consentBox');
if (cb) {
  // 既存の同意状態で初期化
  cb.checked = (getConsent() === 'yes');

  cb.onchange = () => {
    setConsent(cb.checked);
    // チェックONに切り替えた直後、まだ送っていなければ送る（1回だけ）
    if (cb.checked && !state._sentOnce) {
      state._sentOnce = true;

      const sid = localStorage.getItem('km_session')
        || (localStorage.setItem('km_session', (crypto?.randomUUID?.() ?? String(Math.random()))),
            localStorage.getItem('km_session'));

      const { code, scores } = buildCode(); // 念のため最新を取得
      sendToSheets({ code, scores, userAgent:navigator.userAgent, sessionId:sid, t:Date.now() });
    }
  };
}


  // イベント
  $('#retry', el).onclick = () => {
  state = makeInitialState();          // ぜんぶリセット
  state.step = 0;                      // すぐ最初の軸から再開したいなら1に
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};


  $('#export',el).onclick=()=>{ 
  // JSON保存
  const payload={code,meta,scores,answers:state.answers};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`kokkaku-mbti-${code}.json`; a.click();
  URL.revokeObjectURL(url);

  // ボタンでも送るが、一度送っていれば送らない
  if (!state._sentOnce) {
    state._sentOnce = true;
    sendToSheets({ code, scores, userAgent:navigator.userAgent, t:Date.now() });
  }
};

}


// テーブルの前に入れたい場合は↓の行の直前に ${barsHTML} を挿入

function baseLabel(b){
  return b==='WAVE'?'WAVE（柔・軽・下重心）'
       : b==='STRAIGHT'?'STRAIGHT（厚・立体・上重心）'
       : b==='NATURAL'?'NATURAL（骨感・直線・ラフ）' : b;
}
render();
/* ───── ％バー用：各軸の「右側寄り％」を算出 ───── */
function axisPercent(axisKey){
  const arr = state.answers[axisKey].map(Number);
  const qs  = QUESTIONS[axisKey];

  // 0..1 正規化（左向き設問は反転）
  const normalized = arr.map((v,i)=>{
    const s = (v-1)/4;          // 1→0, 5→1
    return qs[i].pos ? s : (1-s);
  });
  const avg = normalized.reduce((a,b)=>a+b,0)/normalized.length; // 0..1
  const pct = Math.round(avg*100); // 0..100（右側＝codePos方向の％）

  // ラベル決定（どちら寄りか）
  const ax = AXES.find(a=>a.key===axisKey);
  const sideLabel = (pct>50) ? ax.posLabel : ax.negLabel;
  return { pct, sideLabel, posSide: pct>50 };
}


</script>



</body>
</html>
